# é“Â·è¡ æ”¹å–„è¨ˆåŠƒ

## ğŸ“‹ ç•¶å‰å•é¡Œç¸½çµ

### å•é¡Œ 1: ç§»å‹•éåº¦åŠ‡æƒ…åŒ– âš ï¸ é«˜å„ªå…ˆç´š
**ç¾è±¡**ï¼š
- ç©å®¶è¼¸å…¥ç°¡å–®çš„ç§»å‹•æŒ‡ä»¤ï¼ˆå¦‚ 'm'ï¼‰ï¼Œå»è§¸ç™¼å¤§é‡åŠ‡æƒ…äº‹ä»¶
- å‡ºç¾ã€Œå¤æ¨¹ã€ã€ã€Œé­”ä¿®ã€ã€ã€Œéˆæºç‰ã€ç­‰ä¸åˆç†çš„éš¨æ©Ÿé­é‡
- ç§»å‹•æ‡‰è©²æ˜¯ç°¡å–®çš„ä½ç½®è®ŠåŒ–ï¼Œè€ŒéåŠ‡æƒ…è§¸ç™¼å™¨

**æ ¹æœ¬åŸå› **ï¼š
1. **ç¼ºä¹çµæ§‹åŒ–åœ°åœ–**ï¼šç•¶å‰ä½¿ç”¨è‡ªç”±æ–‡å­—æè¿°ä½ç½®ï¼ŒAI å¯ä»¥ä»»æ„ç”Ÿæˆåœ°é»å’Œäº‹ä»¶
2. **Drama Agent ä¸ç†è§£ç§»å‹•èªç¾©**ï¼šå¿ƒé­”ç³»çµ±ç¸½æ˜¯è¿½æ±‚æˆ²åŠ‡æ€§ï¼Œå³ä½¿æ˜¯æ™®é€šç§»å‹•
3. **Director è¦å‰‡ä¸å¤ å¼·åˆ¶**ï¼šé›–ç„¶ prompt æœ‰è¦å‰‡ï¼Œä½† AI åœ¨è¤‡é›œæƒ…æ³ä¸‹æœƒå¿½ç•¥

**å½±éŸ¿**ï¼š
- éŠæˆ²ç¯€å¥è¢«æ‰“äº‚
- ç©å®¶å¤±å»å°éŠæˆ²çš„æŒæ§æ„Ÿ
- é‡è¤‡ç§»å‹•æœƒç”¢ç”Ÿå¤§é‡ç„¡æ„ç¾©åŠ‡æƒ…

---

### å•é¡Œ 2: æ•˜è¿°èˆ‡ç‹€æ…‹ä¸åŒæ­¥ ğŸ”´ åš´é‡
**ç¾è±¡**ï¼š
- narrative èªªã€Œç²å¾—éˆæºç‰ã€ï¼Œä½† `items_gained` æ˜¯ç©ºçš„
- èƒŒåŒ…å¯¦éš›ä¸Šæ²’æœ‰å¢åŠ ç‰©å“
- ç©å®¶çœ‹åˆ°çš„æ•…äº‹å’Œå¯¦éš›éŠæˆ²ç‹€æ…‹ä¸ä¸€è‡´

**æ ¹æœ¬åŸå› **ï¼š
1. **Director Agent æ²’æœ‰åš´æ ¼éµå®ˆè¦å‰‡**ï¼šé›–ç„¶ prompt æœ‰æª¢æŸ¥æ¸…å–®ï¼ŒAI ä»å¯èƒ½éºæ¼
2. **ç¼ºä¹é©—è­‰å±¤**ï¼šæ²’æœ‰ä»£ç¢¼å±¤é¢çš„æª¢æŸ¥ç¢ºä¿æ•˜è¿°å’Œç‹€æ…‹ä¸€è‡´
3. **Prompt å·¥ç¨‹çš„ä¾·é™**ï¼šç´”é æ–‡å­—æŒ‡ç¤ºï¼Œç„¡æ³• 100% ä¿è­‰ AI éµå®ˆ

**å½±éŸ¿**ï¼š
- åš´é‡ç ´å£éŠæˆ²é‚è¼¯
- ç©å®¶å›°æƒ‘å’Œä¸ä¿¡ä»»
- æ½›åœ¨çš„å­˜æª”æå£é¢¨éšª

---

### å•é¡Œ 3: Karma ç•°å¸¸å¢é•·
**ç¾è±¡**ï¼š
- é€£çºŒç§»å‹• 4 æ¬¡ï¼Œkarma å¾ 40 â†’ 50 â†’ 60 â†’ 70 â†’ 80
- æ²’æœ‰å¯¦éš›çš„å–„è¡Œæˆ–æƒ¡è¡Œï¼Œåªæ˜¯ç§»å‹•

**æ ¹æœ¬åŸå› **ï¼š
- Drama Agent ç‚ºäº†è£½é€ åŠ‡æƒ…ï¼Œéš¨æ„å¢åŠ  karma
- ç¼ºä¹ karma è®ŠåŒ–çš„è¦å‰‡å’Œé™åˆ¶

**å½±éŸ¿**ï¼š
- éŠæˆ²å¹³è¡¡è¢«ç ´å£
- karma å¤±å»æ„ç¾©

---

## ğŸ—ºï¸ æ ¸å¿ƒè§£æ±ºæ–¹æ¡ˆï¼šçµæ§‹åŒ–ä¸–ç•Œåœ°åœ–ç³»çµ±

### è¨­è¨ˆç†å¿µ
**å¾ã€Œè‡ªç”±ç”Ÿæˆã€è½‰å‘ã€Œçµæ§‹åŒ–æ¢ç´¢ã€**ï¼š
- é å®šç¾©æ‰€æœ‰åœ°é»ã€é€£æ¥é—œä¿‚ã€äº‹ä»¶æ©Ÿç‡
- AI è² è²¬æ•˜äº‹åŒ…è£ï¼Œä¸è² è²¬ä¸–ç•Œçµæ§‹
- ç§»å‹•è®Šæˆç¢ºå®šæ€§æ“ä½œ + å¯é¸éš¨æ©Ÿäº‹ä»¶

### åœ°åœ–æ•¸æ“šçµæ§‹

```python
# src/world_map.py

WORLD_MAP = {
    "é’é›²é–€Â·å±±è…³": {
        "name": "é’é›²é–€Â·å±±è…³",
        "description": "é’é›²é–€çš„å…¥å£ï¼ŒçŸ³éšèœ¿èœ’è€Œä¸Šï¼Œéœ§æ°£ç¹šç¹ã€‚",
        "tier_requirement": 1.0,  # æœ€ä½å¢ƒç•Œè¦æ±‚
        "exits": {
            "north": "é’é›²é–€Â·å¤–é–€å»£å ´",
            "east": "é’é›²é–€Â·éˆè‰å ‚",
        },
        "event_chance": 0.05,  # 5% æ©Ÿç‡è§¸ç™¼éš¨æ©Ÿäº‹ä»¶
        "available_npcs": ["npc_001_master_qingyun"],
        "features": ["éˆæ°£å……æ²›", "é¢¨æ™¯ç§€éº—"],
    },

    "é’é›²é–€Â·å¤–é–€å»£å ´": {
        "name": "é’é›²é–€Â·å¤–é–€å»£å ´",
        "description": "å¯¬é—Šçš„ç·´æ­¦å ´ï¼Œå¤–é–€å¼Ÿå­å€‘åœ¨æ­¤ä¿®ç…‰ã€‚",
        "tier_requirement": 1.0,
        "exits": {
            "south": "é’é›²é–€Â·å±±è…³",
            "north": "é’é›²é–€Â·å…§é–€",
            "west": "é’é›²é–€Â·è—ç¶“é–£",
        },
        "event_chance": 0.10,  # äººå¤šçš„åœ°æ–¹äº‹ä»¶æ©Ÿç‡é«˜
        "available_npcs": ["npc_002_elder_wang", "npc_003_disciple_li"],
        "features": ["å¼Ÿå­çœ¾å¤š", "å¯ä»¥åˆ‡ç£‹"],
    },

    "é’é›²é–€Â·éˆè‰å ‚": {
        "name": "é’é›²é–€Â·éˆè‰å ‚",
        "description": "è—¥é¦™å››æº¢çš„è—¥å ‚ï¼Œé•·è€åœ¨æ­¤ç…‰ä¸¹ã€‚",
        "tier_requirement": 1.0,
        "exits": {
            "west": "é’é›²é–€Â·å±±è…³",
        },
        "event_chance": 0.02,
        "available_npcs": ["npc_004_herbalist_zhang"],
        "features": ["å¯ä»¥è³¼è²·ä¸¹è—¥", "å­¸ç¿’ç…‰ä¸¹"],
    },

    "é’é›²é–€Â·è—ç¶“é–£": {
        "name": "é’é›²é–€Â·è—ç¶“é–£",
        "description": "å¤è€çš„è—æ›¸æ¨“ï¼Œæ”¶è—è‘—å®—é–€ç§˜ç±ã€‚",
        "tier_requirement": 2.0,  # éœ€è¦ç¯‰åŸºæœŸæ‰èƒ½é€²å…¥
        "exits": {
            "east": "é’é›²é–€Â·å¤–é–€å»£å ´",
        },
        "event_chance": 0.15,  # ç§˜ç±ä¹‹åœ°ï¼Œäº‹ä»¶æ©Ÿç‡é«˜
        "available_npcs": ["npc_005_librarian"],
        "features": ["å¯ä»¥å­¸ç¿’æŠ€èƒ½", "éœ€è¦è²¢ç»é»"],
    },

    "é’é›²é–€Â·å…§é–€": {
        "name": "é’é›²é–€Â·å…§é–€",
        "description": "å…§é–€å¼Ÿå­çš„ä¿®ç…‰ä¹‹åœ°ï¼Œéˆæ°£æ¿ƒéƒã€‚",
        "tier_requirement": 2.0,
        "exits": {
            "south": "é’é›²é–€Â·å¤–é–€å»£å ´",
            "north": "é’é›²é–€Â·æŒé–€å¤§æ®¿",
        },
        "event_chance": 0.08,
        "available_npcs": [],
        "features": ["éˆæ°£æ¿ƒåº¦ +50%", "ä¿®ç…‰é€Ÿåº¦åŠ æˆ"],
    },
}

def validate_movement(current_location: str, direction: str, player_tier: float) -> dict:
    """
    é©—è­‰ç§»å‹•æ˜¯å¦åˆæ³•

    Returns:
        {
            "valid": bool,
            "reason": str,  # å¦‚æœ invalid
            "destination": str,  # å¦‚æœ valid
            "description": str,
        }
    """
    if current_location not in WORLD_MAP:
        return {"valid": False, "reason": f"æœªçŸ¥åœ°é»: {current_location}"}

    location = WORLD_MAP[current_location]

    if direction not in location["exits"]:
        available = ", ".join(location["exits"].keys())
        return {"valid": False, "reason": f"æ­¤è™•ç„¡æ³•å¾€{direction}ã€‚å¯ç”¨æ–¹å‘: {available}"}

    destination_name = location["exits"][direction]
    destination = WORLD_MAP[destination_name]

    if player_tier < destination["tier_requirement"]:
        return {
            "valid": False,
            "reason": f"å¢ƒç•Œä¸è¶³ã€‚éœ€è¦ {destination['tier_requirement']}ï¼Œç•¶å‰ {player_tier}"
        }

    return {
        "valid": True,
        "destination": destination_name,
        "description": destination["description"],
    }

def should_trigger_random_event(location: str, player_karma: int) -> bool:
    """
    æ±ºå®šæ˜¯å¦è§¸ç™¼éš¨æ©Ÿäº‹ä»¶

    Args:
        location: ç•¶å‰åœ°é»
        player_karma: ç©å®¶ karma å€¼

    Returns:
        æ˜¯å¦è§¸ç™¼äº‹ä»¶
    """
    import random

    if location not in WORLD_MAP:
        return False

    base_chance = WORLD_MAP[location]["event_chance"]

    # karma å½±éŸ¿äº‹ä»¶æ©Ÿç‡ï¼ˆæœ€å¤š +10%ï¼‰
    karma_bonus = min(player_karma / 1000, 0.10)

    final_chance = base_chance + karma_bonus

    return random.random() < final_chance
```

---

## ğŸ”„ Multi-Agent å·¥ä½œæµç¨‹æ”¹é€²

### ç•¶å‰æµç¨‹ï¼ˆæœ‰å•é¡Œï¼‰
```
ç©å®¶è¼¸å…¥ "å¾€åŒ—èµ°"
  â†“
Observer è§£æ â†’ intent: "MOVE", target: "north"
  â†“
Logic + Drama ä¸¦è¡Œè™•ç†
  â”œâ”€ Logic: "å¯è¡Œï¼Œç§»å‹•æœƒæ¶ˆè€—é«”åŠ›"
  â””â”€ Drama: "ç™¼ç¾å¤æ¨¹ï¼ç™¼ç¾é­”ä¿®ï¼ç™¼ç¾éˆæºç‰ï¼" âŒ
  â†“
Director åˆä½µ â†’ éåº¦åŠ‡æƒ…åŒ– âŒ
```

### æ–°æµç¨‹ï¼ˆçµæ§‹åŒ–ï¼‰
```
ç©å®¶è¼¸å…¥ "å¾€åŒ—èµ°"
  â†“
Observer è§£æ â†’ intent: "MOVE", target: "north"
  â†“
ã€æ–°å¢ã€‘Map Validator é©—è­‰
  - æª¢æŸ¥ current_location çš„ exits æ˜¯å¦æœ‰ "north"
  - æª¢æŸ¥ç›®çš„åœ°çš„ tier_requirement
  - æ±ºå®šæ˜¯å¦è§¸ç™¼éš¨æ©Ÿäº‹ä»¶
  â†“
å¦‚æœ valid ä¸” no random event:
  â†’ ç›´æ¥è¿”å›ç°¡å–®ç§»å‹•æ•˜è¿°ï¼ˆä¸èª¿ç”¨ AIï¼‰âœ…

å¦‚æœ valid ä¸” random event:
  â†“
  Logic: "ç§»å‹•å¯è¡Œï¼Œç•¶å‰ä½ç½®å¯èƒ½æœ‰äº‹ä»¶"
  Drama: "è¨­è¨ˆç°¡çŸ­äº‹ä»¶ï¼ˆä¸æ”¹è®Šä¸»ç·šï¼‰" âœ…
  â†“
  Director: "åˆä½µæ•˜è¿° + åŸ·è¡Œç§»å‹•"

å¦‚æœ invalid:
  â†’ ç›´æ¥è¿”å›éŒ¯èª¤è¨Šæ¯ âœ…
```

---

## ğŸ“ å¯¦æ–½è¨ˆåŠƒ

### Phase 1: æœ€å°å¯è¡Œåœ°åœ– (2 å°æ™‚)

**ç›®æ¨™**ï¼šå»ºç«‹ 10-15 å€‹æ ¸å¿ƒåœ°é»ï¼Œå¯¦ç¾åŸºæœ¬ç§»å‹•ç³»çµ±

**ä»»å‹™æ¸…å–®**ï¼š
- [ ] å‰µå»º `src/world_map.py`
  - [ ] å®šç¾© WORLD_MAP å­—å…¸ï¼ˆ10-15 å€‹åœ°é»ï¼‰
  - [ ] å¯¦ä½œ `validate_movement()` å‡½æ•¸
  - [ ] å¯¦ä½œ `should_trigger_random_event()` å‡½æ•¸
  - [ ] å¯¦ä½œ `get_location_info()` å‡½æ•¸

- [ ] ä¿®æ”¹ `src/main.py`
  - [ ] åœ¨ `process_action()` ä¸­åŠ å…¥åœ°åœ–é©—è­‰
  - [ ] MOVE æ„åœ–å„ªå…ˆèª¿ç”¨ `validate_movement()`
  - [ ] å¦‚æœç§»å‹•åˆæ³•ä¸”ç„¡äº‹ä»¶ï¼Œç›´æ¥è¿”å›ç°¡å–®æ•˜è¿°
  - [ ] åªåœ¨éš¨æ©Ÿäº‹ä»¶æ™‚èª¿ç”¨ Drama Agent

- [ ] ä¿®æ”¹ `src/prompts.py`
  - [ ] Logic Agent: åŠ å…¥åœ°åœ–é©—è­‰çµæœä½œç‚ºè¼¸å…¥
  - [ ] Drama Agent: å¼·èª¿ã€Œåªåœ¨éš¨æ©Ÿäº‹ä»¶æ™‚ç”ŸæˆåŠ‡æƒ…ã€
  - [ ] Director: æ›´æ–°ç§»å‹•è™•ç†é‚è¼¯

- [ ] æ¸¬è©¦
  - [ ] æ¸¬è©¦åˆæ³•ç§»å‹•ï¼ˆç„¡äº‹ä»¶ï¼‰
  - [ ] æ¸¬è©¦éæ³•ç§»å‹•ï¼ˆæ–¹å‘éŒ¯èª¤ï¼‰
  - [ ] æ¸¬è©¦å¢ƒç•Œé™åˆ¶
  - [ ] æ¸¬è©¦éš¨æ©Ÿäº‹ä»¶è§¸ç™¼

**ä»£ç¢¼ç¤ºä¾‹ï¼ˆmain.py ä¿®æ”¹ï¼‰**ï¼š
```python
from world_map import validate_movement, should_trigger_random_event

def process_action(self, user_input: str):
    # ... ç¾æœ‰ä»£ç¢¼ ...

    intent = agent_observer(user_input, recent_events)
    intent_type = intent.get('intent')

    # ã€æ–°å¢ã€‘ç§»å‹•æ„åœ–çš„ç‰¹æ®Šè™•ç†
    if intent_type == 'MOVE':
        direction = intent.get('target')  # 'north', 'south', 'east', 'west'
        current_location = self.player_state['location']

        # é©—è­‰ç§»å‹•
        validation = validate_movement(current_location, direction, self.player_state['tier'])

        if not validation['valid']:
            # éæ³•ç§»å‹•ï¼Œç›´æ¥è¿”å›éŒ¯èª¤
            print(f"\nâŒ {validation['reason']}")
            return

        # åˆæ³•ç§»å‹•ï¼Œæª¢æŸ¥æ˜¯å¦è§¸ç™¼äº‹ä»¶
        trigger_event = should_trigger_random_event(
            validation['destination'],
            self.player_state['karma']
        )

        if not trigger_event:
            # ç°¡å–®ç§»å‹•ï¼Œä¸èª¿ç”¨ AI
            narrative = self._generate_simple_movement_narrative(
                current_location,
                validation['destination'],
                validation['description']
            )

            state_update = {
                'hp_change': 0,
                'mp_change': -5,  # ç§»å‹•æ¶ˆè€—å°‘é‡æ³•åŠ›
                'karma_change': 0,
                'items_gained': [],
                'location_new': validation['destination'],
                'cultivation_progress_change': 0,
            }

            self._apply_state_update(state_update)
            print(f"\n{narrative}")
            return

        # æœ‰äº‹ä»¶ï¼Œç¹¼çºŒæ­£å¸¸æµç¨‹ï¼ˆèª¿ç”¨ Dramaï¼‰
        # ... ç¾æœ‰ Logic + Drama + Director æµç¨‹ ...

def _generate_simple_movement_narrative(self, from_loc: str, to_loc: str, description: str) -> str:
    """ç”Ÿæˆç°¡å–®ç§»å‹•æ•˜è¿°ï¼ˆä¸èª¿ç”¨ AIï¼‰"""
    templates = [
        f"ä½ æ²¿è‘—å±±è·¯å‰è¡Œï¼Œ{description}ç¶“éä¸€æ®µæ™‚é–“ï¼Œä½ ä¾†åˆ°äº†{to_loc}ã€‚",
        f"ä½ é›¢é–‹{from_loc}ï¼Œå‘å‰èµ°å»ã€‚{description}ä¸ä¹…ï¼Œä½ æŠµé”äº†{to_loc}ã€‚",
        f"ä½ é‚æ­¥å‰è¡Œï¼Œ{description}ç‰‡åˆ»ä¹‹å¾Œï¼Œä½ ä¾†åˆ°äº†{to_loc}ã€‚",
    ]
    import random
    return random.choice(templates)
```

---

### Phase 2: éš¨æ©Ÿäº‹ä»¶ç³»çµ± (1 å°æ™‚)

**ç›®æ¨™**ï¼šç‚ºåœ°åœ–æ·»åŠ è±å¯Œçš„éš¨æ©Ÿäº‹ä»¶ï¼Œä½†ä¿æŒå¯æ§

**ä»»å‹™æ¸…å–®**ï¼š
- [ ] å‰µå»º `src/world_events.py`
  - [ ] å®šç¾©æ¯å€‹åœ°é»çš„äº‹ä»¶æ± 
  - [ ] äº‹ä»¶åˆ†ç´šï¼ˆå°äº‹ä»¶ã€ä¸­äº‹ä»¶ã€å¤§äº‹ä»¶ï¼‰
  - [ ] äº‹ä»¶è§¸ç™¼æ¢ä»¶ï¼ˆkarmaã€tierã€æ™‚é–“ç­‰ï¼‰

- [ ] ä¿®æ”¹ Drama Agent prompt
  - [ ] è¼¸å…¥åŒ…å«ã€Œäº‹ä»¶é¡å‹ã€å’Œã€Œäº‹ä»¶ç´šåˆ¥ã€
  - [ ] å¼·åˆ¶éµå®ˆäº‹ä»¶ç´šåˆ¥çš„å½±éŸ¿ç¯„åœ

**äº‹ä»¶ç³»çµ±è¨­è¨ˆ**ï¼š
```python
# src/world_events.py

LOCATION_EVENTS = {
    "é’é›²é–€Â·å¤–é–€å»£å ´": {
        "small": [  # å°äº‹ä»¶ï¼šåªæœ‰å°è©±ï¼Œç„¡å¯¦è³ªå½±éŸ¿
            {
                "trigger": lambda state: state['tier'] >= 1.0,
                "description": "ä¸€ä½å¸«å…„æ­£åœ¨æŒ‡å°æ–°å¼Ÿå­åŠæ³•",
                "max_karma_change": 5,
                "max_items": 0,
            },
            {
                "trigger": lambda state: True,
                "description": "å…©ä½å¼Ÿå­åœ¨åˆ‡ç£‹æ­¦è—",
                "max_karma_change": 3,
                "max_items": 0,
            },
        ],
        "medium": [  # ä¸­äº‹ä»¶ï¼šå¯èƒ½ç²å¾—ç‰©å“æˆ–å°‘é‡ä¿®ç…‰é€²åº¦
            {
                "trigger": lambda state: state['karma'] > 30,
                "description": "é•·è€æ­£åœ¨è¬›è§£ä¿®ç…‰å¿ƒæ³•",
                "max_karma_change": 10,
                "max_items": 1,
                "max_cultivation_progress": 20,
            },
        ],
        "major": [  # å¤§äº‹ä»¶ï¼šé¡¯è‘—å½±éŸ¿ï¼ˆæ¥µä½æ©Ÿç‡ï¼‰
            {
                "trigger": lambda state: state['karma'] > 60 and state['tier'] >= 2.0,
                "description": "å®—é–€æ¯”æ­¦å¤§æœƒå³å°‡é–‹å§‹",
                "max_karma_change": 30,
                "max_items": 2,
                "max_cultivation_progress": 50,
            },
        ],
    },
}

def select_random_event(location: str, player_state: dict) -> dict:
    """
    éš¨æ©Ÿé¸æ“‡ä¸€å€‹é©åˆçš„äº‹ä»¶

    Returns:
        {
            "level": "small" | "medium" | "major",
            "description": str,
            "constraints": {
                "max_karma_change": int,
                "max_items": int,
                "max_cultivation_progress": int,
            }
        }
    """
    # å¯¦ä½œé‚è¼¯...
```

---

### Phase 3: å®Œæ•´åœ°åœ–æ“´å±• (2-3 å¤©)

**ç›®æ¨™**ï¼šå»ºç«‹å®Œæ•´çš„ä¿®ä»™ä¸–ç•Œåœ°åœ–

**ä»»å‹™æ¸…å–®**ï¼š
- [ ] æ“´å±•åˆ° 30-50 å€‹åœ°é»
  - [ ] é’é›²é–€ï¼ˆ10 å€‹åœ°é»ï¼‰
  - [ ] é™„è¿‘åŸé®ï¼ˆ5 å€‹åœ°é»ï¼‰
  - [ ] é‡å¤–å€åŸŸï¼ˆ10 å€‹åœ°é»ï¼‰
  - [ ] ç§˜å¢ƒï¼ˆ5 å€‹åœ°é»ï¼‰
  - [ ] å…¶ä»–å®—é–€ï¼ˆ10 å€‹åœ°é»ï¼‰

- [ ] ç‰¹æ®Šæ©Ÿåˆ¶
  - [ ] å‚³é€é™£ç³»çµ±
  - [ ] éš±è—åœ°é»ï¼ˆéœ€è¦ç‰¹å®šç‰©å“æˆ–æ¢ä»¶ï¼‰
  - [ ] å±éšªå€åŸŸï¼ˆè‡ªå‹•æˆ°é¬¥è§¸ç™¼ï¼‰
  - [ ] å®‰å…¨å€åŸŸï¼ˆç„¡æ³•æˆ°é¬¥ï¼‰

- [ ] åœ°é»æ•ˆæœ
  - [ ] éˆæ°£æ¿ƒåº¦ï¼ˆå½±éŸ¿ä¿®ç…‰é€Ÿåº¦ï¼‰
  - [ ] ç’°å¢ƒåŠ æˆ/æ¸›ç›Š
  - [ ] æ™‚é–“æµé€Ÿï¼ˆæŸäº›ç§˜å¢ƒæ™‚é–“ä¸åŒï¼‰

---

## ğŸ”§ å…¶ä»–æ”¹é€²é …ç›®

### æ”¹é€² 1: æ•˜è¿°èˆ‡ç‹€æ…‹åŒæ­¥é©—è­‰å±¤

**å•é¡Œ**ï¼šå–®é  prompt ç„¡æ³• 100% ä¿è­‰ AI éµå®ˆè¦å‰‡

**è§£æ±ºæ–¹æ¡ˆ**ï¼šåœ¨ä»£ç¢¼å±¤é¢é©—è­‰ Director çš„è¼¸å‡º

```python
def validate_narrative_state_sync(narrative: str, state_update: dict) -> dict:
    """
    é©—è­‰æ•˜è¿°èˆ‡ç‹€æ…‹æ›´æ–°æ˜¯å¦ä¸€è‡´

    Returns:
        {
            "valid": bool,
            "warnings": List[str],  # è­¦å‘Šä¿¡æ¯
            "errors": List[str],    # éŒ¯èª¤ä¿¡æ¯
        }
    """
    warnings = []
    errors = []

    # æª¢æŸ¥ 1: æ•˜è¿°æåˆ°ç²å¾—ç‰©å“ï¼Œä½† items_gained æ˜¯ç©ºçš„
    gain_keywords = ['ç²å¾—', 'å¾—åˆ°', 'æ’¿èµ·', 'æ‹¾å–', 'è³œäºˆ']
    for keyword in gain_keywords:
        if keyword in narrative and not state_update.get('items_gained'):
            errors.append(f"æ•˜è¿°æåˆ°ã€Œ{keyword}ã€ä½† items_gained ç‚ºç©º")

    # æª¢æŸ¥ 2: items_gained æœ‰ç‰©å“ï¼Œä½†æ•˜è¿°æ²’æåˆ°
    if state_update.get('items_gained'):
        for item in state_update['items_gained']:
            if item not in narrative:
                warnings.append(f"items_gained åŒ…å«ã€Œ{item}ã€ä½†æ•˜è¿°ä¸­æœªæåŠ")

    # æª¢æŸ¥ 3: æ•˜è¿°æåˆ°ç§»å‹•ï¼Œä½† location_new æ˜¯ null
    move_keywords = ['ä¾†åˆ°', 'æŠµé”', 'é€²å…¥', 'å‰å¾€']
    for keyword in move_keywords:
        if keyword in narrative and not state_update.get('location_new'):
            errors.append(f"æ•˜è¿°æåˆ°ã€Œ{keyword}ã€ä½† location_new ç‚ºç©º")

    # æª¢æŸ¥ 4: æ•¸å€¼è®ŠåŒ–çš„åˆç†æ€§
    if state_update.get('hp_change', 0) < -100:
        warnings.append(f"HP è®ŠåŒ–éå¤§: {state_update['hp_change']}")

    if state_update.get('karma_change', 0) > 20:
        warnings.append(f"å–®æ¬¡ karma è®ŠåŒ–éå¤§: {state_update['karma_change']}")

    return {
        'valid': len(errors) == 0,
        'warnings': warnings,
        'errors': errors,
    }
```

**æ•´åˆåˆ° main.py**ï¼š
```python
def process_action(self, user_input: str):
    # ... ç²å¾— Director çš„çµæœ ...

    narrative = result.get('narrative')
    state_update = result.get('state_update')

    # é©—è­‰ä¸€è‡´æ€§
    validation = validate_narrative_state_sync(narrative, state_update)

    if not validation['valid']:
        print("\nâš ï¸ AI è¼¸å‡ºé©—è­‰å¤±æ•—ï¼Œæ­£åœ¨é‡è©¦...")
        for error in validation['errors']:
            print(f"   âŒ {error}")

        # é‡è©¦ä¸€æ¬¡ï¼ˆå¸¶è‘—éŒ¯èª¤ä¿¡æ¯ï¼‰
        result = self._retry_director_with_feedback(validation['errors'])

    if validation['warnings']:
        for warning in validation['warnings']:
            print(f"   âš ï¸ {warning}")

    # ç¹¼çºŒæ­£å¸¸æµç¨‹...
```

---

### æ”¹é€² 2: Karma è®ŠåŒ–è¦å‰‡

**ç•¶å‰å•é¡Œ**ï¼škarma éš¨æ„è®ŠåŒ–ï¼Œå¤±å»æ„ç¾©

**è§£æ±ºæ–¹æ¡ˆ**ï¼šåœ¨ Logic Agent ä¸­å¼·åˆ¶ karma è¦å‰‡

```python
# åœ¨ prompts.py çš„ SYSTEM_LOGIC ä¸­åŠ å…¥

ã€Karma è®ŠåŒ–è¦å‰‡ã€‘ï¼ˆå¿…é ˆéµå®ˆï¼‰
1. æ™®é€šç§»å‹•ï¼škarma_change = 0ï¼ˆçµ•å°ä¸èƒ½è®Šï¼‰
2. æ™®é€šå°è©±ï¼škarma_change = Â±5 ä»¥å…§
3. å–„è¡Œï¼ˆå¹«åŠ©ä»–äººã€æç»ã€æ•‘äººï¼‰ï¼š+10 åˆ° +20
4. æƒ¡è¡Œï¼ˆæ®ºäººã€æ¶åŠ«ã€ç ´å£ï¼‰ï¼š-20 åˆ° -50
5. é‡å¤§å–„è¡Œï¼ˆæ‹¯æ•‘æ‘èŠã€æ“Šæ•—å¤§é­”é ­ï¼‰ï¼š+50 åˆ° +100
6. ä¿®ç…‰ã€ä¼‘æ¯ã€æŸ¥çœ‹èƒŒåŒ…ï¼škarma_change = 0

**å¼·åˆ¶è¦å‰‡**ï¼šå¦‚æœè¡Œå‹•ä¸ç¬¦åˆä»¥ä¸Šé¡åˆ¥ï¼Œkarma_change å¿…é ˆç‚º 0
```

---

### æ”¹é€² 3: ç¶“é©—å€¼ç³»çµ±æ¨™æº–åŒ–

**ç•¶å‰å•é¡Œ**ï¼šä¿®ç…‰ç²å¾—çš„ç¶“é©—å€¼ä¸ä¸€è‡´

**è§£æ±ºæ–¹æ¡ˆ**ï¼šå»ºç«‹ç¶“é©—å€¼ç²å¾—æ¨™æº–

```python
# config.py

EXPERIENCE_REWARDS = {
    'CULTIVATE': {
        'base': 10,  # åŸºç¤ä¿®ç…‰
        'deep': 20,  # æ·±åº¦ä¿®ç…‰ï¼ˆéˆæ°£å……æ²›ä¹‹åœ°ï¼‰
        'breakthrough': 50,  # çªç ´é—œéµæœŸ
    },
    'COMBAT': {
        'win_equal': 30,  # æˆ°å‹åŒéš
        'win_higher': 100,  # æˆ°å‹æ›´é«˜éš
        'win_lower': 5,  # æˆ°å‹ä½éšï¼ˆç¶“é©—å¾ˆå°‘ï¼‰
    },
    'QUEST': {
        'minor': 20,  # å°ä»»å‹™
        'major': 100,  # ä¸»è¦ä»»å‹™
        'epic': 500,  # å²è©©ä»»å‹™
    },
}
```

---

## ğŸ¯ å„ªå…ˆç´šæ’åº

### ğŸ”´ é«˜å„ªå…ˆç´šï¼ˆæœ¬é€±å®Œæˆï¼‰
1. **çµæ§‹åŒ–åœ°åœ–ç³»çµ± Phase 1**ï¼ˆè§£æ±ºç§»å‹•å•é¡Œï¼‰
2. **æ•˜è¿°èˆ‡ç‹€æ…‹åŒæ­¥é©—è­‰å±¤**ï¼ˆè§£æ±ºç‰©å“ä¸åŒæ­¥å•é¡Œï¼‰
3. **Karma è®ŠåŒ–è¦å‰‡å¼·åŒ–**ï¼ˆè§£æ±º karma ç•°å¸¸å•é¡Œï¼‰

### ğŸŸ¡ ä¸­å„ªå…ˆç´šï¼ˆä¸‹é€±å®Œæˆï¼‰
4. **éš¨æ©Ÿäº‹ä»¶ç³»çµ± Phase 2**
5. **ç¶“é©—å€¼ç³»çµ±æ¨™æº–åŒ–**
6. **Drama/Logic Agent prompt å„ªåŒ–**

### ğŸŸ¢ ä½å„ªå…ˆç´šï¼ˆæœªä¾† 2-3 é€±ï¼‰
7. **å®Œæ•´åœ°åœ–æ“´å±• Phase 3**
8. **ç‰¹æ®Šæ©Ÿåˆ¶ï¼ˆå‚³é€é™£ã€éš±è—åœ°é»ï¼‰**
9. **åœ°é»æ•ˆæœç³»çµ±**

---

## ğŸ“Š é æœŸæ•ˆæœ

å¯¦æ–½ä»¥ä¸Šæ”¹é€²å¾Œï¼Œé æœŸé”æˆï¼š

**ç§»å‹•ç³»çµ±**ï¼š
- âœ… 99% çš„æ™®é€šç§»å‹•ä¸æœƒè§¸ç™¼åŠ‡æƒ…
- âœ… ç§»å‹•å»¶é²å¾ 6-10 ç§’é™ä½åˆ° < 1 ç§’ï¼ˆç›´æ¥è¿”å›ï¼‰
- âœ… éš¨æ©Ÿäº‹ä»¶å¯æ§ä¸”æœ‰æ„ç¾©

**æ•¸æ“šä¸€è‡´æ€§**ï¼š
- âœ… æ•˜è¿°æåˆ°çš„ç‰©å“ 100% å‡ºç¾åœ¨èƒŒåŒ…
- âœ… æ‰€æœ‰æ•¸å€¼è®ŠåŒ–éƒ½æœ‰æ•˜è¿°æ”¯æŒ
- âœ… é©—è­‰å±¤è‡ªå‹•æ•æ‰éŒ¯èª¤

**éŠæˆ²å¹³è¡¡**ï¼š
- âœ… Karma è®ŠåŒ–æœ‰æ„ç¾©ä¸”å¯é æ¸¬
- âœ… ç¶“é©—å€¼ç²å¾—æ¨™æº–åŒ–
- âœ… å¢ƒç•Œæå‡é€Ÿåº¦åˆç†

**æ•´é«”é«”é©—**ï¼š
- âœ… ç©å®¶æœ‰æŒæ§æ„Ÿ
- âœ… ä¸–ç•Œæ„Ÿè¦ºçœŸå¯¦ä¸”ä¸€è‡´
- âœ… AI æ•˜äº‹ä¿æŒé«˜è³ªé‡ï¼Œä½†åœ¨çµæ§‹åŒ–æ¡†æ¶å…§

---

## ğŸ”„ é·ç§»ç­–ç•¥

**ç¾æœ‰å­˜æª”è™•ç†**ï¼š
- ç”±æ–¼æ˜¯æ—©æœŸé–‹ç™¼éšæ®µï¼Œä¸ä¿ç•™å‘å¾Œå…¼å®¹
- å¯¦æ–½åœ°åœ–ç³»çµ±å¾Œï¼Œç¾æœ‰å­˜æª”çš„ `location` æ¬„ä½éœ€è¦å°æ‡‰åˆ°æ–°åœ°åœ–
- å¦‚æœ `location` åœ¨æ–°åœ°åœ–ä¸­ä¸å­˜åœ¨ï¼Œé‡ç½®åˆ° "é’é›²é–€Â·å±±è…³"

**é·ç§»è…³æœ¬**ï¼ˆå¯é¸ï¼‰ï¼š
```python
# scripts/migrate_saves.py

def migrate_location(old_location: str) -> str:
    """å°‡èˆŠåœ°é»åç¨±å°æ‡‰åˆ°æ–°åœ°åœ–"""
    mapping = {
        "é’é›²é–€": "é’é›²é–€Â·å¤–é–€å»£å ´",
        "éˆè‰å ‚": "é’é›²é–€Â·éˆè‰å ‚",
        # ... æ›´å¤šå°æ‡‰
    }

    return mapping.get(old_location, "é’é›²é–€Â·å±±è…³")
```

---

## ğŸ“ å¾ŒçºŒæ–‡æª”éœ€æ±‚

- [ ] `docs/WORLD_MAP.md` - å®Œæ•´åœ°åœ–æ–‡æª”
- [ ] `docs/EVENT_SYSTEM.md` - äº‹ä»¶ç³»çµ±è¨­è¨ˆæ–‡æª”
- [ ] `docs/GAME_BALANCE.md` - éŠæˆ²å¹³è¡¡æ•¸å€¼è¡¨
- [ ] `docs/AI_AGENT_GUIDE.md` - å„ Agent çš„è©³ç´°è·è²¬å’Œè¦å‰‡

---

**æœ€å¾Œæ›´æ–°**ï¼š2025-01-22
**ç‹€æ…‹**ï¼šå¾…å¯¦æ–½
**é è¨ˆå®Œæˆ**ï¼šPhase 1 (2 å°æ™‚) | Phase 2 (1 å°æ™‚) | Phase 3 (2-3 å¤©)
