# 道·衍 - 架構問題完整報告

## 🔴 核心問題總結

經過自動化測試，發現**4 個核心架構缺陷**導致遊戲無法正常運作：

---

## 1. 【指令處理不一致】❌

### 問題描述
當前所有用戶輸入都強制經過 AI（Observer）解析，包括：
- ✅ 應該用 AI 的：自然語言（「我要去靈草堂」）
- ❌ 不應該用 AI 的：單字母方向（'n', 's', 'e', 'w'）

### 測試結果
```
輸入 'n':
  Observer 解析 -> INSPECT (confidence: 0.2)  ❌ 錯誤！
  應該識別為 -> MOVE, target='n' 或 'north'

輸入 '往北':
  Observer 解析 -> MOVE, target=None  ❌ 無 target！

輸入 '我要往北走':
  Observer 解析 -> MOVE, target=None  ❌ 無 target！

輸入 '北':
  Observer 解析 -> MOVE, target='北方'  ✅ 唯一成功的
```

**Observer 方向識別成功率：1/5 (20%)**

### 根本原因
GPT-4o-mini 無法可靠識別單字母或簡短方向輸入，導致：
- 把 'n' 識別為 INSPECT
- 把 '往北'、'north' 的 target 提取為 None

---

## 2. 【提示與實際處理脫節】❌

### 問題描述
```
【可用方向】
  北 (n) → 青雲門·外門廣場   ← 提示用戶可以輸入 'n'
  東 (e) → 青雲門·靈草堂

請選擇方向: n               ← 用戶輸入 'n'
```

**但系統無法處理 'n'！**

```
用戶輸入: n
→ handle_shortcut() 返回 'n'
→ agent_observer('n')
→ ❌ 識別為 INSPECT (錯誤意圖)
→ ❌ 移動失敗
```

### 用戶體驗災難
- 提示說「輸入 n」
- 用戶輸入 n
- 系統說「我沒有理解你的意思」或「無法移動」
- **用戶完全困惑**

---

## 3. 【Observer target 提取不穩定】❌

### 問題描述
Observer 返回的 `target` 值無法預測：

| 輸入 | intent | target | 能否標準化 | 結果 |
|------|--------|--------|-----------|------|
| `n` | INSPECT | `None` | ❌ | 失敗 |
| `北` | MOVE | `"北方"` | ✅ | 成功 |
| `往北` | MOVE | `None` | ❌ | 失敗 |
| `north` | MOVE | `None` | ❌ | 失敗 |
| `我要往北走` | MOVE | `None` | ❌ | 失敗 |
| `我要去靈草堂` | MOVE | `"靈草堂"` | ❌ | 失敗（是地名不是方向） |

### 發現的 4 種 target 返回模式
1. **None** - 最常見（4/6 的測試）
2. **方向詞** - '北方'（能轉換）
3. **地點名稱** - '靈草堂', '青雲門·內門'（無法轉換）
4. **空字串** - （無法轉換）

**無法預測，完全靠運氣！**

---

## 4. 【缺少統一的方向處理層】❌

### 當前架構
```
用戶輸入 'n'
  ↓
handle_shortcut() → 返回 'n'
  ↓
agent_observer('n') → AI 解析（不穩定）
  ↓
normalize_direction(target) → 標準化
  ↓
validate_movement() → 驗證
```

**問題**：
- 步驟 2（AI 解析）是瓶頸，失敗率 80%
- 沒有快捷路徑直接處理方向
- 所有輸入都走同一條路，無差別處理

### 應有的架構
```
用戶輸入
  ↓
輸入分類器
  ├─ 方向輸入 → 直接處理（繞過 AI）
  ├─ 快捷命令 → 展開處理
  └─ 自然語言 → AI 解析
```

---

## 📊 測試數據總結

### 測試 1: Observer 方向識別
- **成功率**: 1/5 (20%)
- **失敗案例**: 'n', 'north', '往北', '我要往北走'
- **唯一成功**: '北'

### 測試 2: 方向標準化
- **成功率**: 23/24 (96%)
- **唯一問題**: 字串 'None' 無映射（非實際問題）

### 測試 3: 移動驗證邏輯
- **成功率**: 5/5 (100%)
- **結論**: 驗證邏輯沒問題，問題在上游

### 測試 4: 完整移動流程
- **成功率**: 0/1 (0%)
- **失敗原因**: Observer 無法識別 'n'

### 測試 5: INSPECT vs MOVE 識別
- **成功率**: 6/6 (100%) - 自然語言識別正常
- **結論**: AI 能正確處理完整句子，但無法處理單字母/簡短輸入

---

## 🎯 影響範圍

### 無法正常使用的功能
1. ❌ **快捷移動** (`m` → `n`)
2. ❌ **直接方向輸入** (`北`, `north`)
3. ❌ **簡短指令** (`往北`)

### 可以使用的功能
1. ✅ **完整自然語言** (`我要去靈草堂` - 但會把地名當方向)
2. ✅ **查看周圍** (`l`, `我要查看周圍`)
3. ✅ **修煉** (`c`, `我要打坐修煉`)

### 用戶體驗問題
- **混淆度**: ⭐⭐⭐⭐⭐ (5/5) - 提示與實際完全不符
- **挫折感**: ⭐⭐⭐⭐⭐ (5/5) - 明明提示可以用 'n'，卻不行
- **可玩性**: ⭐ (1/5) - 基本無法正常遊玩

---

## 💡 核心問題根源

**單一原因**: 強制所有輸入經過 AI 解析

**為什麼這是錯的**:
- GPT-4o-mini 專長：理解自然語言上下文
- GPT-4o-mini 弱點：單字母、符號、簡短指令

**類比**:
```
讓博士解釋量子力學 → ✅ 優秀
讓博士識別單個字母 → ❌ 大材小用且不可靠
```

---

## 🔧 必須修復的優先級

### P0 (立即修復)
1. **handle_shortcut 方向轉換** - 將 'n' 轉換為 '我要往北走'
2. **統一方向處理入口** - 繞過 AI 直接處理方向輸入

### P1 (近期修復)
3. **重新設計指令架構** - 分層處理不同類型輸入
4. **改進錯誤訊息** - 明確告知用戶問題所在

### P2 (未來優化)
5. **Observer prompt 優化** - 提高 target 提取穩定性
6. **添加 fallback 機制** - AI 失敗時的備用方案

---

## 📝 詳細測試日誌

詳見：
- `test_game_flow.py` - 完整流程測試
- `test_architecture_issues.py` - 架構問題分析

執行測試：
```bash
./venv/bin/python3 test_game_flow.py
./venv/bin/python3 test_architecture_issues.py
```

---

## 結論

**遊戲當前無法正常遊玩**，主要原因是：
1. 提示誤導用戶（說可以輸入 'n'）
2. 系統無法處理（AI 無法識別 'n'）
3. 錯誤訊息混淆（顯示無關信息）

**必須重構指令系統才能解決**，打補丁無法根治。
